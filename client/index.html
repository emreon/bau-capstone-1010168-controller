<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bahcesehir University Capstone Project 1010168 Controller</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
            crossorigin="anonymous"
        />
        <link href="index.css" rel="stylesheet" />
    </head>
    <body>
        <header>
            <nav class="container-fluid navbar bg-dark h-100" oncontextmenu="return false">
                <a class="navbar-brand text-light">ü§ñ Bahcesehir University Capstone Project 1010168 Controller</a>
            </nav>
        </header>
        <main class="container-fluid bg-dark text-light">
            <div class="row h-100">
                <!-- Camera Panel -->
                <div
                    id="camera-panel"
                    class="col-8 p-0 h-100 d-flex flex-column justify-content-center"
                    oncontextmenu="return false"
                >
                    <!-- Camera Panel Overlay -->
                    <div id="camera-panel-overlay">
                        <p class="fs-4">FPS:&nbsp; <span id="fps">0</span></p>
                        <div id="gui"></div>

                        <p id="pos-container" class="fs-4">
                            POS:&nbsp;
                            <span id="pos">
                                X<span id="pos-xmm" class="posmm">000.00</span> Y<span id="pos-ymm" class="posmm"
                                    >000.00</span
                                >&nbsp; (<span id="pos-x" class="pos">0</span>, <span id="pos-y" class="pos">0</span>)
                            </span>
                        </p>
                    </div>
                    <!-- Camera Overlay -->
                    <div id="camera-overlay">
                        <div id="pointer-x"></div>
                        <div id="pointer-y"></div>
                        <div id="workspace"></div>
                    </div>
                    <!-- Camera Image -->
                    <img id="camera" draggable="false" class="mw-100 mh-100 align-self-center" data-camera="off" />
                </div>
                <!-- Control Panel -->
                <div id="control-panel" class="col">
                    <div class="row mb-4">
                        <!-- Calibration -->
                        <div class="col-12 mb-3">
                            <div class="fs-4 mb-0">Calibration</div>
                            <!-- X0 / Y0 -->
                            <div class="input-group">
                                <span style="width: 80px" class="input-group-text"><b>X0 (px)</b></span>
                                <input id="x0" type="number" class="form-control focus" placeholder="0 px" />
                                <span style="width: 80px" class="input-group-text"><b>Y0 (px)</b></span>
                                <input id="y0" type="number" class="form-control focus" placeholder="0 px" />
                            </div>
                            <!-- XX / YY -->
                            <div class="input-group">
                                <span style="width: 80px" class="input-group-text"><b>XX (px)</b></span>
                                <input id="xx" type="number" class="form-control focus" placeholder="1296 px" />
                                <span style="width: 80px" class="input-group-text"><b>YY (px)</b></span>
                                <input id="yy" type="number" class="form-control focus" placeholder="730 px" />
                            </div>
                            <!-- Width / Height -->
                            <div class="input-group">
                                <span style="width: 80px" class="input-group-text"><b>W (mm)</b></span>
                                <input id="wmm" type="number" class="form-control focus" placeholder="100 mm" />
                                <span style="width: 80px" class="input-group-text"><b>H (mm)</b></span>
                                <input id="hmm" type="number" class="form-control focus" placeholder="100 mm" />
                            </div>
                        </div>

                        <!-- Robot Controls -->
                        <div class="col-12 mb-3">
                            <!-- Target -->
                            <div class="fs-4 mb-0">Target</div>
                            <div class="input-group mb-2">
                                <span style="width: 80px" class="input-group-text"><b>X (mm)</b></span>
                                <input id="tx" type="number" class="form-control focus" placeholder="100 mm" />
                                <span style="width: 80px" class="input-group-text"><b>Y (mm)</b></span>
                                <input id="ty" type="number" class="form-control focus" placeholder="100 mm" />
                            </div>
                            <button type="button" class="btn btn-primary">üöÄ MOVE</button>
                            <button type="button" class="btn btn-primary">üß≤ PICK</button>
                            <button type="button" class="btn btn-primary">üéØ RELEASE</button>
                            <button type="button" class="btn btn-primary">üî¥ STOP</button>
                        </div>

                        <!-- Object Detection -->
                        <div class="col-12 mb-3">
                            <div class="fs-4 mb-0">Object Detection</div>
                            <div class="input-group mb-2">
                                <span style="width: 160px" class="input-group-text"><b>Interval (seconds)</b></span>
                                <input id="tx" type="number" class="form-control focus" placeholder="3 seconds" />
                            </div>
                            <button type="button" class="btn btn-primary">‚úçÔ∏è UPDATE</button>
                            <button type="button" class="btn btn-primary">üîÑ REFRESH</button>
                        </div>

                        <!-- Detected Objects -->
                        <div class="col-12 mb-3">
                            <p class="fs-4 mb-0">Detected Objects</p>
                            <div id="objects" class="list-group list-group-numbered">
                                <button class="list-group-item list-group-item-action">
                                    <!-- 
                                        <div class="ms-2 me-auto">
                                        <div class="fw-bold">Subheading</div>
                                            Content for list item
                                        </div>
                                        <span class="badge bg-primary rounded-pill">14</span> 
                                    -->
                                    <span class="object-color">Blue</span>
                                    <span class="object-shape">Triangle</span>
                                    <span class="object-pos">(14.00, 25.20)</span>
                                </button>
                            </div>
                        </div>

                        <!-- Logs -->
                        <div class="col-12 mb-3">
                            <div class="fs-4 mb-0">üìú Logs</div>
                            <!-- 
                                <div class="input-group mb-2">
                                    <span style="width: 160px" class="input-group-text"><b>Interval (seconds)</b></span>
                                    <input id="tx" type="number" class="form-control focus" placeholder="3 seconds" />
                                </div> 
                            -->
                            <textarea rows="2" class="w-100" disabled></textarea>
                            <button type="button" class="btn btn-primary">üóëÔ∏è CLEAR</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"
            integrity="sha512-WoO4Ih0CDOSLYafy22wZD/mcJ7k0ESLqtQsFa6zFKnEUrbtuGU+GkLtVhgt93xa2qewG5gKEC6CWlN8OaCTSVg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>

        <!-- UI -->
        <script>
            {
                const f = [...document.getElementsByClassName('focus')];
                f.forEach((el) => (el.onclick = (e) => e.target.select()));
            }
        </script>

        <!-- Camera Panel -->
        <script>
            // 1296x730 @30 FPS
            const CAM_WIDTH = 1296;
            const CAM_HEIGHT = 730;

            // 100mm X 100mm
            const WORKSPACE_WIDTH = 100;
            const WORKSPACE_HEIGHT = 100;

            let fps = 0;
            let renderedFrames = 0;

            setInterval(() => {
                fps = renderedFrames;
                renderedFrames = 0;

                const fpsEl = document.getElementById('fps');
                fpsEl.textContent = fps;

                if (fps === 0) {
                    const cam = document.getElementById('camera');
                    if (cam.dataset.camera !== 'off') {
                        cam.dataset.camera = 'off';
                        resizeCamOverlay();
                    }
                }
            }, 1000);
            function renderImage(data) {
                const blob = new Blob([data], { type: 'image/jpeg' });
                const blobUrl = URL.createObjectURL(blob);

                const cam = document.getElementById('camera');
                let resize = false;
                if (cam.dataset.camera !== 'on') {
                    cam.dataset.camera = 'on';
                    resize = true;
                }
                cam.onload = (e) => {
                    if (resize) resizeCamOverlay();
                    URL.revokeObjectURL(blobUrl);
                    renderedFrames++;
                    ws.sendMessage('üéûÔ∏è');
                };
                cam.src = blobUrl;
            }

            {
                document.addEventListener('mousemove', (e) => {
                    const camOverlay = document.getElementById('camera-overlay');
                    const camOverlayRect = camOverlay.getBoundingClientRect();

                    const px = document.getElementById('pointer-x');
                    px.style.top = `${e.clientY - camOverlayRect.y}px`;
                    const py = document.getElementById('pointer-y');
                    py.style.left = `${e.clientX - camOverlayRect.x}px`;
                });

                function resizeWorkspace() {
                    const img = getElementById('camera');
                    // const pos = getPos(img, )

                    // const ws = document.getElementById('workspace')
                    // ws.style.left = `${}`
                }

                function resizeCamPanelOverlay() {
                    const camPanel = document.getElementById('camera-panel');
                    const camPanelRect = camPanel.getBoundingClientRect();

                    // TODO: get padding values from the camPanel
                    const camPanelOverlay = document.getElementById('camera-panel-overlay');
                    camPanelOverlay.style.left = `${camPanelRect.left + 32}px`;
                    camPanelOverlay.style.top = `${camPanelRect.top}px`;
                    camPanelOverlay.style.width = `${camPanelRect.width - 48}px`;
                    camPanelOverlay.style.height = `${camPanelRect.height}px`;
                }

                function resizeCamOverlay() {
                    const cam = document.getElementById('camera');
                    const camRect = cam.getBoundingClientRect();

                    const camOverlay = document.getElementById('camera-overlay');
                    camOverlay.style.left = `${camRect.left}px`;
                    camOverlay.style.top = `${camRect.top}px`;
                    camOverlay.style.width = `${camRect.width}px`;
                    camOverlay.style.height = `${camRect.height}px`;
                }

                function onResize() {
                    resizeCamPanelOverlay();
                    resizeCamOverlay();
                }
                window.addEventListener('resize', onResize);
                onResize();

                function getPos(img, pageX, pageY) {
                    const imgRect = img.getBoundingClientRect();

                    const x = Math.min(pageX - imgRect.x, imgRect.width);
                    const y = Math.min(pageY - imgRect.y, imgRect.height);

                    const x0 = parseInt(document.getElementById('x0').value) || 0;
                    const y0 = parseInt(document.getElementById('y0').value) || 0;
                    const xx = parseInt(document.getElementById('xx').value) || CAM_WIDTH;
                    const yy = parseInt(document.getElementById('yy').value) || CAM_HEIGHT;
                    const wmm = parseFloat(document.getElementById('wmm').value) || WORKSPACE_WIDTH;
                    const hmm = parseFloat(document.getElementById('hmm').value) || WORKSPACE_HEIGHT;

                    const xs = parseInt((xx / imgRect.width) * x);
                    const ys = parseInt((yy / imgRect.height) * y);

                    const xxs = parseInt(xx / imgRect.width);

                    const xmm = ((xs - x0) / xx) * wmm;
                    const ymm = ((ys - y0) / yy) * hmm;

                    return { x: xs, y: ys, xmm, ymm, wmm, hmm };
                }

                const img = document.getElementById('camera');
                img.addEventListener('mousemove', (e) => {
                    // if (img.dataset.camera !== 'on') return

                    const img = e.target.closest('#camera');
                    const pos = getPos(img, e.pageX, e.pageY);

                    const xmmi = `${Math.trunc(pos.xmm)}`.padStart(3, '0');
                    const xmmf = `${Math.abs(Math.round((pos.xmm % 1) * 100))}`.padStart(2, '0');

                    const ymmi = `${Math.trunc(pos.ymm)}`.padStart(3, '0');
                    const ymmf = `${Math.abs(Math.round((pos.ymm % 1) * 100))}`.padStart(2, '0');

                    document.getElementById('pos-x').innerText = pos.x;
                    document.getElementById('pos-y').innerText = pos.y;
                    document.getElementById('pos-xmm').innerText = `${xmmi}.${xmmf}`;
                    document.getElementById('pos-ymm').innerText = `${ymmi}.${ymmf}`;
                });

                img.addEventListener('click', (e) => {
                    const img = e.target.closest('#camera');
                    const pos = getPos(img, e.pageX, e.pageY);
                    setTarget(pos);
                    deselectObject();
                });
            }
        </script>

        <!-- Detected Objects -->
        <script>
            function clearObjects() {
                const objects = document.getElementById('objects');
                objects.replaceChildren();
            }

            function addObject(x, y, color, shape) {
                const objects = document.getElementById('objects');
                const objectCount = objects.childElementCount;

                const obj = document.createElement('button');
                obj.classList.add('list-group-item', 'list-group-item-action');
                obj.dataset.shape = shape;
                obj.dataset.color = color;
                obj.dataset.posX = x;
                obj.dataset.posY = y;
                obj.onclick = (e) => {
                    deselectObject();
                    const t = e.target.closest('button.list-group-item');
                    t.classList.add('active');

                    const pos = getPos(
                        document.getElementById('camera'),
                        parseFloat(t.dataset.posX),
                        parseFloat(t.dataset.posY)
                    );
                    setTarget(pos);
                };
                objects.appendChild(obj);

                const numEl = document.createElement('span');
                numEl.innerHTML = `<b>${objectCount + 1}.</b>&nbsp;&nbsp;`;
                obj.appendChild(numEl);

                const colorEl = document.createElement('span');
                colorEl.classList.add('object-color');
                colorEl.innerText = `${color} `;
                obj.appendChild(colorEl);

                const shapeEl = document.createElement('span');
                shapeEl.innerText = `${shape} `;
                obj.appendChild(shapeEl);

                const posEl = document.createElement('span');
                posEl.innerText = `(${x.toFixed(2)}, ${y.toFixed(2)})`;
                obj.appendChild(posEl);
            }

            function deselectObject() {
                const objects = document.getElementById('objects');
                objects.childNodes.forEach((n) => n.classList.remove('active'));
            }

            clearObjects();
            addObject(10, Math.PI, 'Blue', 'Triangle');
            addObject(44, 100, 'Red', 'Square');
            addObject(-40, 200, '?', 'Circle');
            addObject(0, 444, 'Blue', 'Object');
            addObject(10, 50, 'Green', 'Square');
        </script>

        <!-- Control Panel -->
        <script>
            function setTarget(pos) {
                // console.log('Target (mm):', pos.xmm, pos.ymm, ' Target (px):', pos.x, pos.y);
                document.getElementById('tx').value = pos.xmm.toFixed(2);
                document.getElementById('ty').value = pos.ymm.toFixed(2);
            }
        </script>

        <!-- Web Socket -->
        <script>
            console.debug('[WS] Connecting to the server...');
            const WS_ADDR = `ws://${location.hostname}:8888`;
            const td = new TextDecoder();

            const ws = new WebSocket(WS_ADDR);
            ws.binaryType = 'arraybuffer';

            ws.sendMessage = function (msg, cb) {
                if (ws.readyState !== WebSocket.OPEN) return;
                const msgStr = JSON.stringify(msg);
                ws.send(msgStr);
            };

            ws.onopen = (e) => {
                console.debug(`[WS] Connected to "${WS_ADDR}"`, e);
                ws.sendMessage('üß†');
            };

            ws.onmessage = (e) => {
                // TEXT MESSAGE
                if (typeof e.data === 'string') {
                    const msg = JSON.parse(e.data);
                    console.debug('[WS] Message: ', msg);

                    if (msg === 'reset') {
                        location.reload();
                    }
                }

                // BINARY MESSAGE (Handle Incoming Frame)
                else if (e.data instanceof ArrayBuffer) {
                    renderImage(e.data);
                }
            };

            ws.onerror = (e) => {
                console.error('[WS] Error', e);
            };

            ws.onclose = (e) => {
                console.debug('[WS] Connection closed', e);
            };
        </script>

        <!-- Debug GUI -->
        <script>
            // const gui = new dat.GUI({ name: 'EMRE', autoPlace: false, closed: false });
            // const guiContainer = document.getElementById('gui');
            // guiContainer.appendChild(gui.domElement);

            // const guiFolder = gui.addFolder('Folder');
            // const test = { name: 'EMRE' };
            // const guiTest = gui.add(test, 'name');
            // guiTest.domElement.style.pointerEvents = 'none';
        </script>
    </body>
</html>
