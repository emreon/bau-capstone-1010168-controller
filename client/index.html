<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bahcesehir University Capstone Project 1010168 Controller</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
            crossorigin="anonymous"
        />
    </head>
    <body>
        <h1>Bahcesehir University Capstone Project 1010168 Controller</h1>
        <img id="frame" alt="Camera Feed" style="aspect-ratio: 1920/1080; max-width: 80vw" />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"
        ></script>
        <script>
            const WS_ADDR = `ws://${location.hostname}:8888`;
            ws = new WebSocket(WS_ADDR);
            ws.binaryType = 'arraybuffer';
            const td = new TextDecoder();

            ws.sendMessage = (msg, cb) => {
                const msgStr = JSON.stringify(msg);
                ws.send(msgStr);
            };

            ws.onopen = (e) => {
                console.log(`[WS] Connected to "${WS_ADDR}"`, e);
                ws.sendMessage('ðŸ§ ');
                // ws.send(Uint8ClampedArray.from([0x62, 0x75, 0x66, 0x66, 0x65, 0x72]));
            };

            ws.onmessage = (e) => {
                // console.log('[WS] Message', e);

                if (e.data instanceof ArrayBuffer) {
                    handleFrameBuffer(ws, e.data);
                }
            };

            ws.onerror = (e) => {
                console.error('[WS] Error', e);
            };

            ws.onclose = (e) => {
                console.log('[WS] Connection closed', e);
            };

            function handleFrameBuffer(ws, frameBuffer) {
                const blob = new Blob([frameBuffer], { type: 'image/jpeg' });
                // console.log(blob);
                const blobUrl = URL.createObjectURL(blob);
                // console.log(blobUrl);

                // const img = new Image();
                const img = document.getElementById('frame');
                img.onload = (e) => {
                    // console.log('img onload:', e);
                    URL.revokeObjectURL(blobUrl);
                    // ws.sendMessage('loaded');
                };
                img.src = blobUrl;

                // ws.sendMessage('ok');
            }
        </script>
    </body>
</html>
