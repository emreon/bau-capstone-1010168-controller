<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bahcesehir University Capstone Project 1010168 Controller</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
            crossorigin="anonymous"
        />
        <link href="index.css" rel="stylesheet" />
    </head>
    <body>
        <header>
            <nav class="container-fluid navbar bg-dark h-100">
                <a class="navbar-brand text-light">🤖 Bahcesehir University Capstone Project 1010168 Controller</a>
            </nav>
        </header>
        <main class="container-fluid bg-dark text-light">
            <div class="row h-100">
                <div class="col-8 p-0 h-100 d-flex flex-column justify-content-center">
                    <div id="camera-overlay">
                        <p class="fs-4">FPS: <span id="fps">0</span></p>
                        <div id="gui"></div>
                    </div>
                    <img id="camera" class="mw-100 mh-100 align-self-center" data-camera="off" />
                </div>
                <div class="col">---- Control Panel ----</div>
            </div>
        </main>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"
            integrity="sha512-WoO4Ih0CDOSLYafy22wZD/mcJ7k0ESLqtQsFa6zFKnEUrbtuGU+GkLtVhgt93xa2qewG5gKEC6CWlN8OaCTSVg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>

        <script>
            const WS_ADDR = `ws://${location.hostname}:8888`;
            const td = new TextDecoder();
            let fps = 0;
            let renderedFrames = 0;
            let socket = createSocket();

            function createSocket() {
                console.log('[WS] Connecting to the server...');
                const ws = new WebSocket(WS_ADDR);
                ws.binaryType = 'arraybuffer';

                ws.sendMessage = function (msg, cb) {
                    if (ws.readyState !== WebSocket.OPEN) return;
                    const msgStr = JSON.stringify(msg);
                    ws.send(msgStr);
                };

                ws.onopen = (e) => {
                    console.log(`[WS] Connected to "${WS_ADDR}"`, e);
                    ws.sendMessage('🧠');
                };

                ws.onmessage = (e) => {
                    // TEXT MESSAGE
                    if (typeof e.data === 'string') {
                        const msg = JSON.parse(e.data);
                        console.log('[WS] Message: ', msg);

                        // if (msg === 'reset') {
                        //     console.log('[WS] RESET!');
                        //     ws.close();
                        //     // socket = createSocket();
                        // }
                    }

                    // BINARY MESSAGE (Handle Incoming Frame)
                    else if (e.data instanceof ArrayBuffer) {
                        const blob = new Blob([e.data], { type: 'image/jpeg' });
                        const blobUrl = URL.createObjectURL(blob);

                        const cameraImgEl = document.getElementById('camera');
                        cameraImgEl.dataset.camera = 'on';
                        cameraImgEl.onload = (e) => {
                            URL.revokeObjectURL(blobUrl);
                            renderedFrames++;
                            ws.sendMessage('🎞️');
                        };
                        cameraImgEl.src = blobUrl;
                    }
                };

                ws.onerror = (e) => {
                    console.error('[WS] Error', e);
                };

                ws.onclose = (e) => {
                    console.log('[WS] Connection closed', e);
                };

                return ws;
            }

            setInterval(() => {
                fps = renderedFrames;
                renderedFrames = 0;

                const fpsEl = document.getElementById('fps');
                fpsEl.textContent = fps;

                if (fps === 0) {
                    const cameraImgEl = document.getElementById('camera');
                    cameraImgEl.dataset.camera = 'off';
                }
            }, 1000);
        </script>

        <script>
            // const gui = new dat.GUI({ name: 'EMRE', autoPlace: false, closed: false });
            // const guiContainer = document.getElementById('gui');
            // guiContainer.appendChild(gui.domElement);

            // const guiFolder = gui.addFolder('Folder');
            // const test = { name: 'EMRE' };
            // const guiTest = gui.add(test, 'name');
            // guiTest.domElement.style.pointerEvents = 'none';
        </script>
    </body>
</html>
